# Update the API documentation whenever the `main` branch changes.
# This documentation lives in its own `docs` branch.
name: integration-test

on:
  push:
    branches:
      - "local-host"
env:
  BUILDER_VERSION: v0.9.15
  BUILDER_SOURCE: releases
  BUILDER_HOST: https://d19elf31gohf1l.cloudfront.net
  PACKAGE_NAME: aws-c-http
  LINUX_BASE_IMAGE: ubuntu-18-x64
  RUN: ${{ github.run_id }}-${{ github.run_number }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: us-east-1

jobs:
  update-docs-branch:
    runs-on: ubuntu-20.04 # latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install nginx
        run: |
          sudo apt install curl gnupg2 ca-certificates lsb-release ubuntu-keyring
          ./integration-testing/config-local-host.sh

      - name: Build and test
        run: |
          aws s3 cp s3://aws-crt-test-stuff/ci/${{ env.BUILDER_VERSION }}/linux-container-ci.sh ./linux-container-ci.sh && chmod a+x ./linux-container-ci.sh
          ./linux-container-ci.sh ${{ env.BUILDER_VERSION }} aws-crt-${{ env.LINUX_BASE_IMAGE }} build -p ${{ env.PACKAGE_NAME }} --cmake-extra=-DENABLE_LOCAL_HOST_INTEGRATION_TESTS=ON
